\chapter{Оптимизация преобразований базисов}
\addcontentsline{toc}{chapter}{Оптимизация преобразований базисов}
\section{О комбинированном использовании полиномиального и нормального базисов}

Программные реализации умножения в нормальных базисах оказались медленнее алгоритмов умножения в стандартных базисах
даже в полях небольших размерностей. Сравнение двух типов базисов, стандартного и нормального, наводит на мысль об ускорении арифметики в конечных полях
за счет использования выгодных сторон каждого из них. Действительно, умножение быстрее производить в стандартном представлении поля $GF(2^n)$, а возведение
в степень - в нормальном представлении.

Для реализации этой идеи понадобятся матрицы перехода от нормального базиса к стандартному и обратно, которые могут оказаться не разряженными, 
а плотными, и тогда сложность перехода от одного базиса к другому в худшем случае будет $O(n^2/log n)$(если использовать для умножения матрицы на вектор
метод "четырех русских").

Но в удачном случае сложность перехода может оказаться даже не выше линейной, например в случае, если число ненулевых элементов в матрицах переходов будет
$O(n)$. Таким образом, возникает задача поиска нормальных базисов с "простыми" матрицами переходов к стандартным базисам и обратно.

Эта задача легко решается в случае оптимальных нормальных базисов первого типа. 
\begin{Theorem}
Переход от стандартного базиса поля $GF(q^n)$ к соответствующему(с тем же генератором) оптимальному нормальному базису первого типа(если, конечно, он 
существует для данного $n$) и обратно можно выполнить с линейной сложностью.
\end{Theorem}
\begin{proof}
Легко видеть, что в этом случае базис $\{\zeta,...,\zeta^n\}$(не совсем стандартный) совпадает с точностью до перестановки с оптимальным 
нормальным базисом
$$\{\zeta,\zeta^q,\zeta^{q^2},\zeta^{q^{n-1}}\},$$
так как последовательность чисел $1, q, q^2, ..., q^{n-1}$, вычисленных по модулю $p$, совпадает с некоторой перестановкой
$$\{1,2,...,n\}$$
в силу того, что $\zeta$ есть примитивный корень $p-й$ степени из единицы в поле $GF(q^n)$, а $q$ - примитивный корень $p$-й степени из единицы в поле 
$GF(q^n)$, а $q$ - примитивный корень по модулю $p$. 

Поэтому, очевидно, переход от базиса $\{\zeta,...,\zeta^n\}$ к нормальному базису 
$$\{\zeta,\zeta^q,\zeta^{q^2},\zeta^{q^{n-1}}\}$$
и обратно выполняется с оценкой сложности не более чем $n$.

Отметим попутно, что $\zeta$ является корнем неприводимого над полем $GF(q)$ многочлена
$$1+X+...+X^n=\frac{X^p-1}{X-1}$$
Стандартным базисом для перехода будет базис $\{1,\zeta,...,\zeta^{n-1}\}$. Очевидно, он с линейной сложностью выражается через базис
$\{\zeta,...,\zeta^n\}$, поскольку 
$$\zeta^n=1+\zeta+...+\zeta^{n-1},$$
и обратно, базис $\{\zeta,...,\zeta^n\}$, благодаря формуле
$$1=\zeta+...+\zeta^{n-1}+\zeta^n,$$
с линейной сложностью выражается через базис $\{1,\zeta,...,\zeta^{n-1}\}$. В результате имеем, что переход от
оптималього нормального базиса 
$$\{\zeta,\zeta^q,\zeta^{q^2},...,\zeta^{q^{n-1}}\}$$
к стандартному базису $\{1,\zeta,...,\zeta^{n-1}\}$ и обратно выполняется с линейной сложностью.
\end{proof}

\section{Оценка сложности перехода от оптимальных нормальных базисов второго и третьего типа к стандартным и обратно}

Вначале докажем несколько вспомогательных утверждений (следующая лемма выполняется и для общего случая).
Пусть $x=\alpha_1$ - генератор оптимального нормального базиса
$$\{\alpha_1,...,\alpha_n\}$$
второго типа поля $GF(q^n)$, он же генератор соответствующего стандартного базиса $\{x^0,...,x^{n-1}\}$, т.е. $\alpha_1=x^{q^{k-1}}=\zeta^{q^{k-1}}+\zeta^{-q^{k-1}},$
и при любом $k \le n$
$$\alpha_k = x^{q^{k-1}}= \zeta^{q^{k-1}}+\zeta^{-q^{k-1}},$$
где $\zeta$ - примитивный корень из 1 степени $p=2n+1$ в поле $GF(q^{2n})$.

Рассмотрим вспомогательную последовательность $a_0, a_1,...,$ порожденную элементом $x$. Положим $a_0 = 2$ (в случае $p=2$, $a_0=0$) и, далее, 
$a_k=\zeta^k + \zeta^{-k}, k=1,2,..., a_1=\alpha_1$.

Элементы $a_1, a_2,...,a_n$ этой последовательности образуют почти нормальный базис, являющийся перестановкой элментов нормального базиса.

\begin{Lemma}\label{lemma}
Для любого $k \ge 1$ имеют место следующие рекуррентные соотношения:
\\~~1. $a_{k+1}=a_ka_1 - a_{k-1}$
\\~~2. $a_{p^k}= x^{p^k}$.
\\~~3. $a_{p^k+i}=a_ix^{p^k}-a_{p^k-i}.$
\end{Lemma}
\begin{proof}
Для доказательства первой формулы заметим, что
$$(\zeta^k+\zeta^{-k})(\zeta+\zeta^{-1})=\zeta^{k-1}+\zeta^{-k+1}+\zeta^{k+1}+\zeta^{-k-1},$$
т.е. $a_ka_1-a_{k-1}=a_{k+1}.$

Вторая формула очевидна.

Третья формула проверяется непосредственно:
\begin{align}
a_{p^k+i}=\zeta^{p^k+i}+\zeta^{-p^k-i}=(\zeta^{p^k}+\zeta^{-p^k})(\zeta^i+\zeta^-i)-(\zeta^{p^k-i}+\zeta^{-p^k+i})=\nonumber\\
=a_{p^k}a_i-a_{p^k-i}=x^{p^k}a_i-a_{p^k-i}.\nonumber
\end{align}
\end{proof}

Рекуррентные соотношения, доказанные в лемме, позволяют записать формулы перехода от почти стандартного базиса $\{x^1,...,x^n\}$ к почти нормальному
базису.

В случае $p=2$ вычитание в лемме можно заменить на сложение.

Из леммы следует, что для любого $i \ge 1$ элемент $a_i$ почти нормального базиса $\alpha_i$ выражается в виде значения некоторого многочлена степени 
$i$ над полем $GF(q)$, т.е.
$$a_i=f_i(x)=\sum_{j=1}^{i}f_{i,j}x^j.$$

Выразив таким образом все элементы $a_i$ почти нормального базиса в почти стандартном базисе, получим матрицу перехода $F_n=(f_{i,j})$ от почти стандартного
базиса к почти нормальному. В случае, когда $p=2$ плотность $S(F_n)$(количество ненулевых элементов) матрицы $F_n$ оценивается следующим образом:

\begin{Theorem}
Плотность матрицы перехода от почти стандартного базиса поля $GF(2^n)$ к почти нормальному базису второго или третьего типа равна $O(n^{\log_23})$.
\end{Theorem}

Из этой теоремы видно, что матрица перехода является разряженной, и это позволяет осуществлять быстрое умножение в этом базисе. Приведем доказательство
этой теоремы.
\begin{proof}
Согласно формулам предыдущей леммы (\ref{lemma}), матрица $F_{2n+1}$, построенная с их помощью, имеет при $n=2^k-1$ вид:
\begin{equation}
F_{2n+1}=
\left(
\begin{matrix}
  	F_n   & o_n & O_n \\
  	0...0 & 1   & 0...0 \\
	G_n   & o_n & F_n \\
\end{matrix}
\right)
\end{equation}
где $o_n$ - нулевой вектор-столбец высоты $n$, $O_n$ - нулевая $n \times n$ матрица, матрица $G_n$ есть симметрическое отражение матрицы $F_n$ относительно
средней строки, т.е. $G_n = I_n F_n$, где $I_n = (\delta_{i, n-i+1})$ - матрица с единицами на побочной диагонали и нулями в остальных местах. 
Например, матрица $F_7$ выглядит так:
\begin{equation}
F_7=
\left(
\begin{matrix}
  	1 & 0 & 0 & 0 & 0 & 0 & 0 \\
  	0 & 1 & 0 & 0 & 0 & 0 & 0 \\
	1 & 0 & 1 & 0 & 0 & 0 & 0 \\
	0 & 0 & 0 & 1 & 0 & 0 & 0 \\
	1 & 0 & 1 & 0 & 1 & 0 & 0 \\
	0 & 1 & 0 & 0 & 0 & 1 & 0 \\                                           
	1 & 0 & 0 & 0 & 1 & 0 & 1 \\
\end{matrix}
\right)
\end{equation}

Если разбить матрицу на 4 квадратных подматрицы, удалив среднюю строку и средний столбец, получим, что левый верхний квадрат $3 \times 3$ симметричен 
относительно горизонтали левому нижнему и равен нижнему правому квадрату. Средняя строка и средний столбец содержат ровно одну единицу, лежащую на их 
пересечении. Матрица является нижнетреугольной с единицами на главной диагонали. Действительно, в общем случае согласно лемме (\ref{lemma}), при 
$0 \le i \le 2^k$
$$\sum_{j=1}^{2^k+i}f_{2^k+i,j}x^j=a_{2^k+i}=a_ix^{2^k}+a_{2^k-i}=\sum_{j=1}^{i}f_{i,j}x^{2^k+j}+\sum_{j=1}^{2^k-i}f_{2^k-i,j}x^j,$$
откуда имеем $f_{2^k+i,j}=f_{2^k-i,j},$ при $0 \le j \le 2^k$, и $f_{2^k+i,2^k+j}=f_{i,j}$ при $1 \le j \le 2^k$.

Опираясь на это представление, можно получить следующую рекуррентную формулу для вычисления плотности последовательности матриц $F_n$
$$S(F_{2n+1})=3S(F_n)+1, n \ge 3, S(F_3)=4,$$
из которой вытекает рекуррентная формула
$$S(F_{2^k-1})=3S(F_{2^{k-1}-1})+1, k \ge 2, S(F_3)=4.$$

Полагая $l(k) = S(F_{2^k-1}),$ перейдем к линейному рекуррентному соотношению $l(k)=3l(k-1)+1, l(2)=4$, решением которого будет
$l(k)=(3^k-1)/2.$ Обозначив $n=2^k-1$ и выразив $3^k=(2^k)^{\log_23}=(n+1)^{\log_23},$ получим, что
$$S(F_n)=l(k)=\frac{(n+1)^{\log_23}-1}{2}=O(n^{log_23})$$

В общем случае равенство $S(F_n)=O(n^{\log_23})$ сохраняется, так как выбрав $k$ таким образом, что $2^k-1 < n \le 2^{k+1}-1$, можно заметить, что матрица
$F_n$ является главной подматрицей матрицы $F_m$, $m=2^k-1$, откуда имеем
$$S(F_n)\le S(F_m)=O(m^{log_23})=O(n^{\log_23}).$$
Аналогично можно оценить плотность матрицы $F_n'=F_n\cdot B_n$, и непосредственно проверяется, что в матрице $B_n$ все элементы нулевые, кроме элементов
$b_{i,i+1}=1$ над диагональю и некоторых элементов нижней строки $b_{n,j}$ и справедливы следующие равенства для элементов матрицы $F_n':$
$$f_{i,1}'=f_{i,n}b_{n,1}=\delta_{i,n}b_{n,1}, f_{i,j}'=f_{i,j-1}+f_{i,n}b_{n,j}=f_{i,j-1}+\delta_{i,n}b_{n,j},$$
так как в силу того, что матрица $F_n$ нижнетреугольная, для ее элементов имеем $f_{i,n}=\delta_{i,n}$, где $\delta_{i,n}$ - дельта-символ Кронекера. 
Складывая эти равенства, получим, что
$$S(F_n')=\sum_{i=1,j=1}^{n,n-1}f_{i,j}+\sum_{j=1}^{n}b_{n,j}=S(F_n)-1+\sum_{j=1}^{n}b_{n,j}\le S(F_n)-1+n=O(n^{\log_23}).$$
\end{proof} 

Обозначим через $L(F_n)$ сложность линейного преобразования, определяемого матрицей $F_n$ (в данном случае - это наименьшее число операций сложения по 
модулю два, необходимых для вычисления этого преобразования).
\begin{Theorem}
$L(F_n)\le \frac{n}{2}\log_2n+2n=O(n\log_2n)$
\end{Theorem}     
\begin{proof}
Нам будет удобно оценивать сложность преобразования, задаваемого транспонированной матрицей $F_n^T$, которая равна $L(F_n)$ согласно известной лемме о
взаимосвязи сложности транспонированных матриц (см. например \cite{gashkov1}). Впрочем, для дальнейшего нам нужно будет оценить сложность перехода
от координат в нормальном базисе
$$\sum_{i=1}^{n}x_i\alpha_i$$
к координатам в почти стандартном базисе
$$\sum_{i=1}^{n}y_ix^i,$$
которая определяется как раз матрицей $F^T_n$. Пусть $2^k \le n \le 2^{k+1},$ тогда с использованием формул из леммы имеем
\begin{align*}
\sum_{i=1}^{n}y_ix^i=\sum_{i=1}^{n}x_ia_i=\sum_{i=1}^{2^k}x_ia_i+\sum_{i=2^k+1}^{n}x_ia_i=\\
=\sum_{i=1}^{2^k}x_ia_i+\sum_{i=1}^{n-2^k}x_{i+2^k}a_{i+2^k}=\sum_{i=1}^{2^k}x_ia_i+\sum_{i=1}^{n-2^k}x_{i+2^k}(a^{2^k}a_i+a_{2^k-i})=\\
=x_{2^k}a_{2^k}+\sum_{i=1}^{2^{k+1}-n-1}x_ia_i+\sum_{i=2^{k+1}-n}^{2^k-1}(x_i+x_{2^{k+1}-i})a_i+a^{2^k}\sum_{i=1}^{n-2^k}x_{i+2^k}a_i,
\end{align*}
где $a_0=0$. Далее, определяя векторы-столбцы 
$$X=\{x_1,...,x_n\}^T,$$ 
$$X_1=\{x_1,...,x_{2^{k+1}-n-1},x_{2^{k+1}-n}+x_n,...,x_{2^k-1}+x_{2^k+1},x_{2^k}\}^T,$$
где, естественно, в случае $n=2^{k+1}-1$
$$X_1=\{x_1+x_n,...,x_{2^k-1}+x_{2^k+1},x_{2^k}\}^T,$$
а в случае $n=2^{k+1}$
$$X_1=\{x_1+x_{n-1},...,x_{2^k-1}+x_{2^k+1},x_{2^k}\}^T,$$
и во всех случаях 
$$X_2=\{x_{1+2^k,...,x_n}\}^T,$$
и вектора-строки
$$Y_1=\{y_1,...,y_{2^k}\}, Y_2=\{y_{1+2^k},...,y_n\},$$
получим
\begin{align*}
\sum_{i=1}^{n}y_ix^i=\sum_{i=1}^{n}x_ia_i=\sum_{i=1}^{2^k}X_{1,i}a_{i}+x^{2^k}\sum_{i=1}^{n-2^k}X_{2,i}a_i=\\
=\sum_{i=1}^{2^k}Y_{1,i}a^i+\sum_{i=1}^{n-2^k}Y_{2,i+2^k}a_{i+2^k},
\end{align*}
значит
$$F^T_n\otimes X=(y_i'...y_n')=(Y_1,Y_2)=(F^T_{2^k}\otimes X_1, F^T_{n-2^k}\otimes X_2),$$
где $\otimes$ - операция умножения матрицы на вектор в поле $GF(2)$. Разумеется, последнее равенство можно было получить, основываясь только на
структуре матрицы $F_n$. Осталось индуктивно оценить сложность преобразования координат, определяемого матрицей $F^T_n$. Согласно последнему равенству
$$L(2^{m+1})\le 2^m-1+2L(2^m), m\le k-1, L(2)=2$$
По индукции непосредственно проверяется, что
$$L(2^m)=2^{m-1}m+1$$
Для произвольного $n$ в пределах $2^k < n < 2^{k+1}$ получим
\begin{align*}
L(n)\le 2^{k_s-1}k_s+...+2^{k_1-1}k_1+s-1+(n-2^{k_s})+...\\
...+(n-2^{k_s-...-2^{k_2}})\le \frac{n}{2}\log_2n+c\frac{n}{2},
\end{align*}
где
$$c=1\frac{2}{2}+\frac{3}{4}+\frac{4}{8}+\frac{5}{16}+...<4$$	                                            
\end{proof}

\begin{Theorem}
Сложность $B(n)$ перехода в поле $GF(2^n)$ от оптимального нормального базиса второго или третьего типа к соответсвтующему стандартному
и наоборот удовлетворяет неравенству
$$B(n)\le \frac{n}{2}\log_2n + 3n$$
\begin{proof}
Обозначим $x=\zeta+\zeta^{-1}$ генератор стандартного базиса
$$A = \{1,x^1,...,x^{n-1}\}$$
и базиса второго или третьего типа 
$$B = \{x^{2^0}, x^{2^1},...,x^{2^{n-1}}\}.$$

\textbf{Переход от нормального базиса к стандартному}.
Переход будет осуществляться через цепочку из четырех базисов
$$B\to B'\to A' \to A$$
и преобразования координат элемента $f$ поля $GF(2^n)$ в этих базисах
$$f=\sum_{i=1}^{n}x_ix^{2^{i-1}}=\sum_{i=1}^{n}x_i'a_i=\sum_{i=1}^{n}y_i'x^i=\sum_{i=1}^{n}y_ix^{i-1},$$
где $a_i$ обозначает $\zeta^i+\zeta^{-i}, B'=\{a_1,...,a_n\}, A'=\{x^1,...,x^n\}.$

\textbf{Переход от базиса $B$ к базису $B'$ и преобразование  координат $\tilde{x}$ к координатам $\tilde{x}'$}. 
Этот переход осуществляется перестановкой базисных элементов, и действительно, существует такая перестановка $\pi(i)$ чисел
$\{1,...,n\}$, что для любого $i=1,...,2n$ выполняется равенство
\begin{equation}\label{plusminus}
2^i\mod p=\pm \pi(i) \in \{1,...,n\}.
\end{equation}
В самом деле, для базиса второго типа последовательность степеней
$$1,2,2^2,...,2^{2n-1},$$
вычисленных по модулю $p$, совпадает с некоторой перестановкой 
$$\pi(1),...,\pi(2n)$$
множества чисел $\{1,...,2n\}$ в силу того, что 2 - примитивный корень по модулю $p$. А в силу эквивалентности
$$2^{k+n}\equiv -2^k\mod p,$$
(по теореме Ферма $2^{2n}\equiv 1\mod p$, значит, $2^n\equiv -1\mod p$) окончательно получим формулу (\ref{plusminus})

В случае же базиса третьего типа число 2 является квадратичным вычетом по модулю $p$, поэтому все степени $2^k\mod p, k=1,...,n-1$
образуют перестановку множества всех квадратичных вычетов по модулю $p$, так как их ровно $n$ штук. Добавив к этому тот факт, что $p$ равно 3
по модулю 4, и поэтому -1 является квадратичным невычетом по модулю $p$, так как в противном случае существовало бы такое число $r$, что 
$-1 \equiv r^2\mod p$, а это приводило к противоречию с теоремой Ферма:
$$r^{p-1}=(r^2)^{\frac{p-1}{2}}\equiv-1\mod p,$$
и тот факт, что произведение вычета на невычет является невычетом, получаем, что последовательность $-2^k\mod p, k=0,...,n-1$ образует
перестановку множества всех квадратичных невычетов по модулю $p$, в итоге получаем, что и в этом случае верна формула (\ref{plusminus})
\end{proof}
\end{Theorem}
